<template>
	<div class="relative">
		<div class="flex flex-1 items-start gap-0 py-5">
			<!-- Main Content Grid -->
			<main class="min-w-0 w-full">
				<!-- Toolbar -->
				<div class="mb-5 flex items-center justify-between">
					<div class="flex items-center gap-2">
						<span class="font-zt_medium text-sm text-gray-500">Showing</span>
						<span class="font-zt_semibold text-sm text-gray-900">{{
							filteredVulnerabilities.length
						}}</span>
						<span class="text-sm text-gray-500">vulnerabilities</span>
					</div>
					<div class="flex items-center gap-4">
						<!-- Search Bar -->
						<div class="group relative w-full md:w-60">
							<div
								class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
								<font-awesome-icon
									:icon="['fas', 'search']"
									class="text-gray-400 transition-colors" />
							</div>
							<input
								v-model="searchQuery"
								type="text"
								placeholder="Search vulnerabilities..."
								class="block w-full rounded-lg border border-gray-200 bg-gray-50 py-2 pl-10 pr-10 text-sm text-gray-900 outline-none transition-all hover:border-gray-300 hover:bg-white focus:border-zt_purple focus:bg-white" />
							<div
								v-if="searchQuery"
								class="absolute inset-y-0 right-0 flex cursor-pointer items-center pr-3 hover:text-gray-700"
								@click="searchQuery = ''">
								<font-awesome-icon
									:icon="['fas', 'times']"
									class="text-gray-400" />
							</div>
						</div>

						<!-- Severity Filter Dropdown -->
						<div class="relative items-center">
							<button
								class="flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 font-zt_medium text-sm text-gray-700 shadow-sm transition-all hover:border-gray-300 hover:bg-gray-50 focus:border-zt_purple"
								@click="toggleSeverityDropdown">
								<font-awesome-icon
									:icon="['fas', 'filter']"
									class="text-xs text-gray-400" />
								<span>Severity</span>
								<span
									v-if="selectedSeverities.length > 0"
									class="ml-1 flex h-5 w-5 items-center justify-center rounded-full bg-zt_purple text-[10px] font-bold text-white">
									{{ selectedSeverities.length }}
								</span>
								<font-awesome-icon
									:icon="['fas', 'chevron-down']"
									class="ml-2 text-[10px] text-gray-400 transition-transform duration-200"
									:class="{ 'rotate-180': isSeverityDropdownOpen }" />
							</button>

							<!-- Dropdown Menu -->
							<transition
								enter-active-class="transition ease-out duration-100"
								enter-from-class="transform opacity-0 scale-95"
								enter-to-class="transform opacity-100 scale-100"
								leave-active-class="transition ease-in duration-75"
								leave-from-class="transform opacity-100 scale-100"
								leave-to-class="transform opacity-0 scale-95">
								<div
									v-if="isSeverityDropdownOpen"
									class="absolute right-0 z-20 mt-2 w-56 origin-top-right rounded-lg bg-white p-2 shadow-xl ring-1 ring-black ring-opacity-5 focus:outline-none">
									<div class="space-y-1">
										<button
											v-for="sev in severities"
											:key="sev"
											class="flex w-full items-center justify-between rounded-md px-3 py-2 text-sm transition-colors hover:bg-gray-50"
											@click="toggleSeverity(sev)">
											<div class="flex items-center gap-3">
												<span
													class="h-2 w-2 rounded-full"
													:class="{
														'bg-red-500': sev === 'critical',
														'bg-orange-500': sev === 'high',
														'bg-yellow-500': sev === 'medium',
														'bg-blue-500': sev === 'low',
														'bg-gray-400': sev === 'info',
													}"></span>
												<span class="capitalize text-gray-700">{{
													sev
												}}</span>
											</div>
											<font-awesome-icon
												v-if="selectedSeverities.includes(sev)"
												:icon="['fas', 'check']"
												class="text-zt_purple" />
										</button>
									</div>
									<div
										v-if="selectedSeverities.length > 0"
										class="mt-2 border-t pt-2">
										<button
											class="w-full py-1 text-center font-zt_medium text-xs text-gray-500 hover:text-zt_purple"
											@click="selectedSeverities = []">
											Clear Selection
										</button>
									</div>
								</div>
							</transition>

							<!-- Backdrop to close -->
							<div
								v-if="isSeverityDropdownOpen"
								class="fixed inset-0 z-10 cursor-default"
								@click="isSeverityDropdownOpen = false"></div>
						</div>
					</div>
				</div>

				<transition-group
					name="list"
					tag="div"
					class="relative flex flex-col gap-4">
					<!-- No Results State -->
					<div
						v-if="filteredVulnerabilities.length === 0"
						key="no-results"
						class="flex flex-col items-center justify-center rounded-xl border border-dashed border-gray-300 bg-white py-16 text-center shadow-sm">
						<div
							class="mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-gray-50 text-gray-300">
							<font-awesome-icon
								:icon="['fas', 'search']"
								class="text-3xl" />
						</div>
						<h3 class="mb-1 font-zt_semibold text-lg text-gray-900">
							No vulnerabilities found
						</h3>
						<p class="text-sm text-gray-500">
							We couldn't find anything matching your search criteria.
						</p>
						<button
							class="mt-6 rounded-lg bg-zt_purple px-5 py-2.5 font-zt_medium text-sm text-white shadow-sm transition-all hover:bg-purple-700 hover:shadow"
							@click="resetFilters">
							Clear Filters
						</button>
					</div>

					<!-- Vulnerability Cards -->
					<VulnerabilityCard
						v-for="vuln in filteredVulnerabilities"
						:key="vuln.code"
						:vuln="vuln"
						:expanded="expandedVuln === vuln.code"
						@toggle="toggleExpand(vuln.code)" />
				</transition-group>
			</main>

			<!-- Sidebar Filters -->
			<aside class="hidden  w-[1px] translate-x-[70px] space-y-8 self-start xl:block sticky top-28">
				<div>
					<div class="mb-4">
						<h3 class="mt-0 font-zt_semibold text-xs uppercase tracking-wider text-zt_gray">
							Categories
						</h3>
					</div>
					<nav class="space-y-5">
						<button
							v-for="cat in categories"
							:key="cat.id"
							class="group flex text-nowrap w-full items-center justify-between border-l-[3px] px-3 py-0 font-zt_medium text-sm transition-all duration-200"
							:class="
								selectedCategory === cat.id
									? ' border-zt_purple text-zt_purple'
									: 'border-transparent text-gray-500 hover:text-black'
							"
							@click="selectCategory(cat.id)">
							<div class="flex items-center gap-x-10">
								<span>{{ cat.name }}</span>
							<span
								v-if="selectedCategory === cat.id"
								class="flex h-5 items-center justify-center tracking-wider rounded-full bg-gray-100 px-2 font-zt_semibold text-[10px] text-black">
								{{ getCategoryCount(cat.id) }}
							</span>
							</div>
						</button>
					</nav>
				</div>
			</aside>
		</div>
	</div>
</template>

<script setup>
import { ref, computed } from 'vue';
import { VULNERABILITY_REGISTRY } from '@zerothreatai/vulnerability-registry';
import VulnerabilityCard from './VulnerabilityCard.vue';

const searchQuery = ref('');
const selectedSeverities = ref([]);
const selectedCategory = ref('all');
const expandedVuln = ref(null);
const isSeverityDropdownOpen = ref(false);

const severities = ['critical', 'high', 'medium', 'low', 'info'];

const registryArray = Object.values(VULNERABILITY_REGISTRY);

const categories = computed(() => {
	const categoryMap = new Map();
	categoryMap.set('all', { id: 'all', name: 'All Categories' });
	
	registryArray.forEach((vuln) => {
		const cat = vuln.category || 'uncategorized';
		if (!categoryMap.has(cat)) {
			const name = cat
				.split('_')
				.map((word) => word.charAt(0).toUpperCase() + word.slice(1))
				.join(' ');
			categoryMap.set(cat, { id: cat, name });
		}
	});
	
	return Array.from(categoryMap.values());
});

const filteredVulnerabilities = computed(() => {
	return registryArray.filter((vuln) => {
		const title = vuln.title || '';
		const code = vuln.code || '';
		const severity = vuln.severity || '';
		const category = vuln.category || 'uncategorized';

		const matchesSearch =
			title.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
			code.toLowerCase().includes(searchQuery.value.toLowerCase());

		const matchesSeverity =
			selectedSeverities.value.length === 0 ||
			selectedSeverities.value.includes(severity.toLowerCase());

		const matchesCategory =
			selectedCategory.value === 'all' || category === selectedCategory.value;

		return matchesSearch && matchesSeverity && matchesCategory;
	});
});

const toggleSeverityDropdown = () => {
	isSeverityDropdownOpen.value = !isSeverityDropdownOpen.value;
};

const toggleSeverity = (severity) => {
	const index = selectedSeverities.value.indexOf(severity);
	if (index > -1) {
		selectedSeverities.value.splice(index, 1);
	} else {
		selectedSeverities.value.push(severity);
	}
};

const selectCategory = (categoryId) => {
	selectedCategory.value = categoryId;
};

const getCategoryCount = (categoryId) => {
	if (categoryId === 'all') {
		return registryArray.length;
	}
	return registryArray.filter((v) => v.category === categoryId).length;
};

const toggleExpand = (code) => {
	expandedVuln.value = expandedVuln.value === code ? null : code;
};

const resetFilters = () => {
	searchQuery.value = '';
	selectedSeverities.value = [];
	selectedCategory.value = 'all';
};
</script>

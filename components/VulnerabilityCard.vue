<template>
	<div
		class="group relative overflow-hidden rounded-xl border transition-all duration-300 hover:border-zt_purple/50 hover:shadow-md bg-white"
		:class="{ 'shadow-md': expanded }">
		<!-- Card Summary (Always Visible) -->
		<div
			class="flex cursor-pointer items-center justify-between px-5 py-4 transition-colors duration-200"
			:class="{ 'bg-slate-50': expanded }"
			@click="$emit('toggle')">
			<!-- Header: Code + Severity + Category -->
			<div>
				<!-- Title -->
				<h3
					class="w-full max-w-[540px] truncate font-zt_medium text-sm leading-tight text-gray-800 transition-colors group-hover:text-zt_purple my-0"
					:title="vuln.title">
					{{ vuln.title }}
				</h3>
				<div class="mt-4 flex flex-wrap items-center gap-3">
					<span
						class="rounded-md border bg-white px-2 py-0.5 font-zt_medium text-[11px] text-gray-500">
						{{ vuln.code }}
					</span>
					<span
						class="inline-flex items-center rounded-full px-2.5 py-1 font-zt_medium text-xs capitalize leading-none"
						:class="severityClasses">
						{{ vuln.severity }}
					</span>
					<span
						class="flex items-center gap-1.5 rounded-full bg-gray-100 px-2 py-0.5 font-zt_medium text-xs text-gray-500 inline-block">
						<font-awesome-icon
							:icon="['fas', 'layer-group']"
							class="text-xs opacity-70" />
						{{ formatCategory(vuln.category) }}
					</span>
				</div>
			</div>

			<!-- Action Area -->
			<div class="flex shrink-0 items-center gap-3">
				<button
					class="flex h-8 w-8 items-center justify-center rounded-full border text-sm text-gray-600 transition-all hover:bg-slate-100"
					:class="{ 'rotate-180 bg-white': expanded }">
					<font-awesome-icon :icon="['fas', 'chevron-down']" />
				</button>
			</div>
		</div>

		<!-- Expanded Details -->
		<transition
			enter-active-class="transition duration-300 ease-out"
			enter-from-class="transform opacity-0 -translate-y-2"
			enter-to-class="transform opacity-100 translate-y-0"
			leave-active-class="transition duration-200 ease-in"
			leave-from-class="transform opacity-100 translate-y-0"
			leave-to-class="transform opacity-0 -translate-y-2">
			<div
				v-if="expanded"
				class="border-t border-gray-100 bg-white p-6 tracking-wide">
				<div class="flex flex-col gap-8">
					<!-- INFO GRID: Scanner & CVSS -->
					<div
						class="grid grid-cols-1 gap-6 rounded-lg border bg-gray-50 p-4 md:grid-cols-2">
						<!-- Scanner Info -->
						<div>
							<h6
								class="mb-2 font-zt_semibold text-[11px] uppercase tracking-widest text-gray-400">
								Detection Source
							</h6>
							<div class="flex items-center gap-2">
								<div
									class="flex h-8 w-8 items-center justify-center rounded-lg border border-gray-200 bg-white text-zt_purple shadow-sm">
									<font-awesome-icon :icon="['fas', 'robot']" />
								</div>
								<div>
									<span class="font-zt_semibold text-[13px] capitalize text-gray-900 block">
										{{ vuln.scanner }} Scanner
									</span>
									<span class="text-xs text-gray-500 block pt-0.5">Automated detection</span>
								</div>
							</div>
						</div>

						<!-- CVSS Info -->
						<div
							v-if="vuln.cvss"
							class="border-l pl-6">
							<h5
								class="mb-2 font-zt_semibold text-[11px] uppercase tracking-wider text-gray-400">
								CVSS v3.1
							</h5>
							<div class="flex items-start gap-3">
								<div
									class="flex h-8 w-8 items-center justify-center rounded-lg border font-zt_semibold text-xs shadow-sm"
									:class="cvssScoreClass(vuln.cvss.score)">
									{{ vuln.cvss.score }}
								</div>
								<div class="min-w-0 flex-1">
									<div class="flex items-center gap-2">
										<span class="font-zt_semibold text-[13px] text-gray-900">
											{{ vuln.cvss.severity }}
										</span>
										<span class="text-xs text-gray-400">Score</span>
									</div>
									<span
										class="mt-1 inline-block max-w-full break-all overflow-hidden text-ellipsis whitespace-nowrap rounded-sm bg-gray-100 px-1.5 py-0.5 text-[10px] text-gray-500"
										:title="vuln.cvss.vector">
										{{ vuln.cvss.vector }}
									</span>
								</div>
							</div>
						</div>
					</div>

					<!-- Description -->
					<div>
						<h4
							class="mb-3 flex items-center gap-2 font-zt_semibold text-sm text-gray-900">
							<span class="h-1.5 w-1.5 rounded-full bg-zt_purple"></span>
							Description
						</h4>
						<div
							class="border-l-2 border-gray-100 pl-3.5 text-sm leading-relaxed text-gray-600">
							{{ vuln.description }}
						</div>
					</div>

					<!-- Remediation -->
					<div>
						<h4
							class="mb-3 flex items-center gap-2 font-zt_semibold text-sm text-gray-900">
							<span class="h-1.5 w-1.5 rounded-full bg-green-500"></span>
							Remediation
						</h4>
						<div class="rounded-lg border border-green-100 bg-green-50/50 p-4">
							<div class="text-sm leading-relaxed text-gray-700">
								{{ vuln.remediation }}
							</div>
						</div>
					</div>

					<!-- References Grid -->
					<div
						class="grid grid-cols-1 gap-6 border-t border-gray-100 pt-4 md:grid-cols-2">
						<!-- CWE -->
						<div v-if="vuln.cwe && vuln.cwe.length">
							<h4
								class="mb-3 font-zt_medium text-[11px] uppercase tracking-wider text-gray-400">
								Common Weakness Enumeration (CWE)
							</h4>
							<div class="flex flex-col gap-2">
								<a
									v-for="cwe in vuln.cwe"
									:key="cwe.id"
									:href="cwe.url"
									target="_blank"
									class="group flex items-center justify-between rounded-lg border border-gray-200 bg-white p-2.5 transition-all hover:border-blue-300 hover:shadow-sm">
									<div class="flex items-center gap-3 overflow-hidden">
										<span
											class="shrink-0 rounded bg-blue-50 px-2 py-0.5 font-zt_semibold text-[11px] text-blue-700 group-hover:bg-blue-100">
											{{ cwe.id }}
										</span>
										<span
											class="truncate font-zt_medium text-xs text-gray-600 group-hover:text-gray-900">
											{{ cwe.name }}
										</span>
									</div>
									<font-awesome-icon
										:icon="['fas', 'external-link-alt']"
										class="text-xs text-gray-300 group-hover:text-blue-500" />
								</a>
							</div>
						</div>

						<!-- OWASP -->
						<div v-if="vuln.owasp && vuln.owasp.length">
							<h4
								class="mb-3 font-zt_medium text-[11px] uppercase tracking-wider text-gray-400">
								OWASP Top 10
							</h4>
							<div class="flex flex-col gap-2">
								<a
									v-for="owasp in vuln.owasp"
									:key="owasp.id"
									:href="owasp.url"
									target="_blank"
									class="group flex items-center justify-between rounded-lg border border-gray-200 bg-white p-2.5 transition-all hover:border-purple-300 hover:shadow-sm">
									<div class="flex items-center gap-3 overflow-hidden">
										<span
											class="shrink-0 rounded bg-purple-50 px-2 py-0.5 font-zt_semibold text-[11px] text-purple-700 group-hover:bg-purple-100">
											{{ owasp.id }}
										</span>
										<span
											class="truncate font-zt_medium text-xs text-gray-600 group-hover:text-gray-900">
											{{ owasp.name }}
										</span>
									</div>
									<font-awesome-icon
										:icon="['fas', 'external-link-alt']"
										class="text-xs text-gray-300 group-hover:text-purple-500" />
								</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</transition>
	</div>
</template>

<script setup>
import { computed } from 'vue';

const props = defineProps({
	vuln: {
		type: Object,
		required: true,
	},
	expanded: {
		type: Boolean,
		default: false,
	},
});

defineEmits(['toggle']);

const severityClasses = computed(() => {
	const severity = props.vuln.severity?.toLowerCase();
	const classes = {
		critical: 'bg-red-100 text-rose-500',
		high: 'bg-orange-100 text-orange-400',
		medium: 'bg-yellow-100/70 text-yellow-500',
		low: 'bg-blue-100 text-blue-500',
		info: 'bg-gray-100 text-gray-700',
	};
	return classes[severity] || 'bg-gray-100 text-gray-700';
});

const formatCategory = (category) => {
	if (!category) return 'Uncategorized';
	return category
		.split('_')
		.map((word) => word.charAt(0).toUpperCase() + word.slice(1))
		.join(' ');
};

const cvssScoreClass = (score) => {
	if (score >= 9.0) return 'bg-red-100 text-red-700 border-red-200';
	if (score >= 7.0) return 'bg-orange-50 text-orange-600 border-orange-100';
	if (score >= 4.0) return 'bg-yellow-100 text-yellow-700 border-yellow-200';
	return 'bg-blue-100 text-blue-700 border-blue-200';
};
</script>
